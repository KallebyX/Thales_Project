{% extends 'base.html' %}

{% block title %}Administra√ß√£o - ECG IA Prim√°rio{% endblock %}

{% block content %}
<section class="admin-dashboard fade-in">
  <div class="dashboard-header">
    <h1>√Årea Administrativa</h1>
    <p>Gerencie usu√°rios, pacientes, uploads, estat√≠sticas e atividades.</p>
  </div>

  <!-- Estat√≠sticas e Gr√°ficos -->
  <div class="admin-stats">
    <div class="stat-card">
      <h3>Total de Usu√°rios</h3>
      <p>{{ users|length }}</p>
    </div>
    <div class="stat-card">
      <h3>Usu√°rios Novos por M√™s</h3>
      <canvas id="userGrowthChart"></canvas>
    </div>
  </div>

  <!-- Pesquisa de Usu√°rios -->
  <div class="admin-search">
    <input type="text" id="userSearch" placeholder="Buscar usu√°rio por nome ou email..." />
  </div>

  <!-- Tabela de Usu√°rios -->
  <div class="admin-table-container">
    <h2>Usu√°rios Cadastrados</h2>
    <div class="table-wrapper">
      <table class="admin-table" id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Admin?</th>
            <th>√öltimo Login</th>
            <th>IP</th>
            <th>Cadastro</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td class="user-name">{{ user.username }}</td>
            <td class="user-email">{{ user.email }}</td>
            <td>{% if user.is_admin %}‚úÖ{% else %}‚ùå{% endif %}</td>
            <td>{{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else '-' }}</td>
            <td>{{ user.last_ip or '-' }}</td>
            <td>{{ user.created_at.strftime('%d/%m/%Y') }}</td>
            <td class="user-status">{% if user.is_banned %}<span class="banned">Banido</span>{% else %}<span class="active">Ativo</span>{% endif %}</td>
            <td>
              <button class="btn-small btn-edit" onclick="openEditModal({{ user.id }}, '{{ user.username }}', '{{ user.email }}')">‚úèÔ∏è</button>
              {% if not user.is_admin %}
                <button class="btn-small btn-promote" onclick="confirmAction('/promote-user/{{ user.id }}', 'Promover administrador', 'Promover {{ user.username }}?')">‚≠ê</button>
              {% else %}
                {% if user.id != current_user.id %}
                  <button class="btn-small btn-demote" onclick="confirmAction('/demote-user/{{ user.id }}', 'Remover administrador', 'Remover privil√©gios de {{ user.username }}?')">üö´</button>
                {% endif %}
              {% endif %}
              {% if user.is_banned %}
                <button class="btn-small btn-unban" onclick="confirmAction('/unban-user/{{ user.id }}', 'Desbanir usu√°rio', 'Desbanir {{ user.username }}?')">üîì</button>
              {% else %}
                <button class="btn-small btn-ban" onclick="confirmAction('/ban-user/{{ user.id }}', 'Banir usu√°rio', 'Banir {{ user.username }} temporariamente?')">üîí</button>
              {% endif %}
              <button class="btn-small btn-reset" onclick="confirmAction('/reset-password/{{ user.id }}', 'Redefinir senha', 'Enviar nova senha para {{ user.username }}?')">üîë</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal de Confirma√ß√£o -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2 id="confirmTitle">Confirmar A√ß√£o</h2>
    <p id="confirmMessage"></p>
    <div class="modal-actions">
      <form id="confirmForm" method="POST">
        <button type="submit" class="btn-primary">Confirmar</button>
      </form>
      <button type="button" onclick="closeModal()" class="btn-secondary">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h2>Editar Usu√°rio</h2>
    <form id="editForm" method="POST">
      <input type="text" name="username" id="editUsername" placeholder="Nome" required>
      <input type="email" name="email" id="editEmail" placeholder="Email" required>
      <button type="submit" class="btn-primary">Salvar</button>
      <button type="button" onclick="closeEditModal()" class="btn-secondary">Cancelar</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Gera√ß√£o de gr√°fico de crescimento de usu√°rios
  const ctx = document.getElementById('userGrowthChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ user_growth.labels|tojson }},
      datasets: [{
        label: 'Novos Usu√°rios',
        data: {{ user_growth.data|tojson }},
        fill: false,
        tension: 0.3
      }]
    }
  });

  // Pesquisa de usu√°rios
  document.getElementById('userSearch').addEventListener('input', function(){
    const term = this.value.toLowerCase();
    document.querySelectorAll('#usersTable tbody tr').forEach(row=>{
      const name = row.querySelector('.user-name').textContent.toLowerCase();
      const email = row.querySelector('.user-email').textContent.toLowerCase();
      row.style.display = (name.includes(term)||email.includes(term)) ? '' : 'none';
    });
  });

  // Fun√ß√µes de modal de confirma√ß√£o
  function confirmAction(url, title, message){
    document.getElementById('confirmForm').action = url;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'block';
  }
  function closeModal(){
    document.getElementById('confirmModal').style.display = 'none';
  }
  window.onclick = function(e){
    if(e.target == document.getElementById('confirmModal')) closeModal();
  };

  // Modal de edi√ß√£o
  function openEditModal(id, name, email){
    document.getElementById('editForm').action = '/edit-user/' + id;
    document.getElementById('editUsername').value = name;
    document.getElementById('editEmail').value = email;
    document.getElementById('editModal').style.display = 'block';
  }
  function closeEditModal(){
    document.getElementById('editModal').style.display = 'none';
  }
  window.onclick = function(e){
    if(e.target == document.getElementById('editModal')) closeEditModal();
  };
</script>
{% endblock %}